name: MilkMan CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: milkman
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: Welcome@1234
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Grant execute permission for gradlew
      run: chmod +x middleware/gradlew

    - name: Build Middleware
      run: ./gradlew clean build
      working-directory: middleware

    - name: Run Unit Tests
      run: ./gradlew test
      working-directory: middleware

    - name: Generate Code Coverage Report
      run: ./gradlew jacocoTestReport
      working-directory: middleware

    - name: Initialize Database Schema
      run: |
        export PGPASSWORD=Welcome@1234
        psql -h localhost -p 5433 -U postgres -d milkman -c "CREATE SCHEMA IF NOT EXISTS milkman;"

    - name: Start Middleware Application
      run: |
        nohup ./gradlew bootRun > app.log 2>&1 &
        echo $! > app.pid
        sleep 30
      working-directory: middleware
      env:
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5433/milkman
        SPRING_DATASOURCE_USERNAME: postgres
        SPRING_DATASOURCE_PASSWORD: Welcome@1234

    - name: Wait for Application to be Ready
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8081/milkman/healthCheck; do echo "Waiting for app..."; sleep 2; done'
        echo "Application is ready!"

    - name: Setup Automation Tests
      run: |
        cp .env.example .env
        npm install
      working-directory: automation-tests

    - name: Seed Database
      run: |
        node scripts/seed.js
        
        echo "Promoting Admin..."
        export PGPASSWORD=Welcome@1234
        psql -h localhost -p 5433 -U postgres -d milkman -c "UPDATE milkman.customers SET role = 'ADMIN' WHERE pphone = '9876543210';"
      working-directory: automation-tests


    - name: Run API Automation Tests
      run: npm run test:api
      working-directory: automation-tests
      continue-on-error: true

    - name: Run UI Automation Tests
      run: npm run test:ui
      working-directory: automation-tests
      continue-on-error: true
      env:
        HEADLESS: true

    - name: Stop Middleware Application
      if: always()
      run: |
        if [ -f middleware/app.pid ]; then
          kill $(cat middleware/app.pid) || true
          rm middleware/app.pid
        fi

    - name: Upload Unit Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-reports
        path: middleware/build/reports/tests/test/

    - name: Upload Code Coverage Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: middleware/build/reports/jacoco/test/

    - name: Upload API Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-test-reports
        path: automation-tests/reports/api/

    - name: Upload UI Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-reports
        path: automation-tests/reports/ui/

    - name: Upload Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-screenshots
        path: automation-tests/reports/screenshots/
        if-no-files-found: ignore

    - name: Upload Application Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: application-logs
        path: middleware/app.log
        if-no-files-found: ignore

    - name: Test Summary
      if: always()
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Unit Tests" >> $GITHUB_STEP_SUMMARY
        echo "- Location: middleware/build/reports/tests/test/index.html" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Code Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- Location: middleware/build/reports/jacoco/test/html/index.html" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### API Automation Tests" >> $GITHUB_STEP_SUMMARY
        echo "- Location: automation-tests/reports/api/api-test-report.html" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### UI Automation Tests" >> $GITHUB_STEP_SUMMARY
        echo "- Location: automation-tests/reports/ui/ui-test-report.html" >> $GITHUB_STEP_SUMMARY
